name: bench-13.3

on:
  pull_request:
    types: [opened, reopened, synchronize]
  workflow_dispatch:
    inputs:
      matrix_size:
        description: "Benchmark matrix size"
        required: true
        default: "reduced"
        type: choice
        options:
          - reduced
          - full
      regression_gate:
        description: "Run regression comparator gate (reduced set only)"
        required: true
        default: false
        type: boolean
      baseline_path:
        description: "Baseline JSON path (repo-relative) used when regression_gate=true"
        required: false
        default: ""
        type: string
      threshold:
        description: "Regression threshold ratio (e.g. 0.10 = 10%)"
        required: false
        default: "0.10"
        type: string

jobs:
  official-fixture-contract:
    runs-on: ubuntu-latest
    env:
      TZ: UTC
      LC_ALL: C
      TPCH_DBGEN_REPO: https://github.com/electrum/tpch-dbgen.git
      TPCH_DBGEN_REF: 32f1c1b92d1664dba542e927d23d86ffa57aa253
      TPCH_SCALE: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Generate official TPC-H fixtures and parquet
        shell: bash
        run: |
          set -euo pipefail
          make tpch-dbgen-sf1
          make tpch-dbgen-parquet
          make validate-tpch-dbgen-manifests

      - name: Re-run generation to detect drift
        shell: bash
        run: |
          set -euo pipefail
          cp tests/bench/fixtures/tpch_dbgen_sf1/manifest.json /tmp/tpch_tbl_manifest_run1.json
          cp tests/bench/fixtures/tpch_dbgen_sf1_parquet/manifest.json /tmp/tpch_parquet_manifest_run1.json
          make tpch-dbgen-sf1
          make tpch-dbgen-parquet
          make validate-tpch-dbgen-manifests
          cmp -s /tmp/tpch_tbl_manifest_run1.json tests/bench/fixtures/tpch_dbgen_sf1/manifest.json
          cmp -s /tmp/tpch_parquet_manifest_run1.json tests/bench/fixtures/tpch_dbgen_sf1_parquet/manifest.json

      - name: Upload official fixture manifests
        uses: actions/upload-artifact@v4
        with:
          name: official-tpch-fixture-manifests-${{ github.run_id }}
          path: |
            tests/bench/fixtures/tpch_dbgen_sf1/manifest.json
            tests/bench/fixtures/tpch_dbgen_sf1_parquet/manifest.json
          if-no-files-found: error
          retention-days: 30

  embedded:
    runs-on: ubuntu-latest
    env:
      TZ: UTC
      LC_ALL: C
      FFQ_BENCH_OUT_DIR: tests/bench/results
      FFQ_BENCH_THREADS: "1"
      FFQ_BENCH_BATCH_SIZE_ROWS: "8192"
      FFQ_BENCH_MEM_BUDGET_BYTES: "536870912"
      FFQ_BENCH_SHUFFLE_PARTITIONS: "64"
      FFQ_BENCH_MAX_CV_PCT: "30.0"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Select benchmark matrix
        id: matrix
        shell: bash
        run: |
          set -euo pipefail
          MATRIX_MODE="${{ github.event_name == 'workflow_dispatch' && inputs.matrix_size || 'reduced' }}"
          if [[ "${MATRIX_MODE}" == "full" ]]; then
            echo "mode=full" >> "$GITHUB_OUTPUT"
            echo "warmup=1" >> "$GITHUB_OUTPUT"
            echo "iterations=3" >> "$GITHUB_OUTPUT"
            echo "rag_matrix=1000,16,10,1.0;5000,32,10,0.8;10000,64,10,0.2" >> "$GITHUB_OUTPUT"
          else
            echo "mode=reduced" >> "$GITHUB_OUTPUT"
            echo "warmup=0" >> "$GITHUB_OUTPUT"
            echo "iterations=2" >> "$GITHUB_OUTPUT"
            echo "rag_matrix=1000,16,5,1.0;5000,32,10,0.5" >> "$GITHUB_OUTPUT"
          fi

      - name: Run embedded benchmark
        shell: bash
        run: |
          set -euo pipefail
          export FFQ_BENCH_MODE=embedded
          export FFQ_BENCH_WARMUP="${{ steps.matrix.outputs.warmup }}"
          export FFQ_BENCH_ITERATIONS="${{ steps.matrix.outputs.iterations }}"
          export FFQ_BENCH_RAG_MATRIX="${{ steps.matrix.outputs.rag_matrix }}"
          make bench-13.3-embedded

      - name: Resolve candidate artifact
        id: candidate
        shell: bash
        run: |
          set -euo pipefail
          CANDIDATE_JSON="$(ls -t tests/bench/results/*.json | head -n1)"
          echo "json=${CANDIDATE_JSON}" >> "$GITHUB_OUTPUT"
          echo "candidate_json=${CANDIDATE_JSON}" >> "$GITHUB_STEP_SUMMARY"

      - name: Regression gate (optional)
        if: >-
          ${{
            github.event_name == 'workflow_dispatch' &&
            inputs.regression_gate &&
            steps.matrix.outputs.mode == 'reduced'
          }}
        shell: bash
        run: |
          set -euo pipefail
          BASELINE="${{ inputs.baseline_path }}"
          THRESHOLD="${{ inputs.threshold }}"
          if [[ -z "${BASELINE}" ]]; then
            echo "baseline_path is required when regression_gate=true"
            exit 1
          fi
          make bench-13.3-compare BASELINE="${BASELINE}" CANDIDATE="${{ steps.candidate.outputs.json }}" THRESHOLD="${THRESHOLD}"

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bench-13_3-${{ github.run_id }}-${{ steps.matrix.outputs.mode }}
          path: |
            tests/bench/results/*.json
            tests/bench/results/*.csv
          if-no-files-found: error
          retention-days: 30
