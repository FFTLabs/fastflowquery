name: python-wheels

on:
  pull_request:
  workflow_dispatch:

jobs:
  wheel-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Build manylinux wheel
        uses: PyO3/maturin-action@v1
        with:
          command: build
          args: --release --out dist
      - name: Wheel smoke test (pip install + collect)
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyarrow dist/*.whl
          python - <<'PY'
          import os
          import ffq
          root = os.getcwd()
          lineitem = os.path.join(root, "tests/fixtures/parquet/lineitem.parquet")
          e = ffq.Engine()
          e.register_table("lineitem", lineitem)
          df = e.sql("SELECT l_orderkey FROM lineitem LIMIT 1")
          t = df.collect()
          assert t.num_rows == 1, t
          print("python wheel smoke: OK")
          PY
      - name: Upload Linux wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-linux
          path: dist/*

  wheel-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Build macOS wheel
        uses: PyO3/maturin-action@v1
        with:
          command: build
          args: --release --out dist
      - name: Wheel smoke test (pip install + collect)
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyarrow dist/*.whl
          python - <<'PY'
          import os
          import ffq
          root = os.getcwd()
          lineitem = os.path.join(root, "tests/fixtures/parquet/lineitem.parquet")
          e = ffq.Engine()
          e.register_table("lineitem", lineitem)
          df = e.sql("SELECT l_orderkey FROM lineitem LIMIT 1")
          t = df.collect()
          assert t.num_rows == 1, t
          print("python wheel smoke: OK")
          PY
      - name: Upload macOS wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-macos
          path: dist/*
